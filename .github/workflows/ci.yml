# 工作流名称
name: Node.js CI - TianShuFrontend

# 触发工作流的事件
on:
  push:
    branches: [ "main" ] # 当有代码推送到 main 分支时触发
  pull_request:
    branches: [ "main" ] # 当有 PR 合并到 main 分支时触发

env:
  ALIYUN_REGISTRY: crpi-1kkkjpeehkoxqf8e.cn-shanghai.personal.cr.aliyuncs.com
  
  # 项目特定的镜像名称和端口
  IMAGE_NAME: tianshufrontend       
  IMAGE_TAG: latest                 
  PORT: 5173                    

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Node.js 20.x
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Install pnpm
      run: npm install -g pnpm
        
    - name: Set API URL for Production
      if: secrets.API_HOST
      run: |
        echo "VITE_API_BASE_URL='https://${{ secrets.API_HOST }}'" >> .env.production
        echo "API URL has been set in .env.production"
          
    - name: Build project
      run: |
        pnpm install
        pnpm run build
        # 将打包好的 dist 目录复制到 docker 上下文中，以便构建镜像
        cp -r ./dist ./docker/

    - name: Login to Aliyun Container Registry
      if: github.event_name == 'push'
      uses: docker/login-action@v2
      with:
        registry: ${{ env.ALIYUN_REGISTRY }}
        username: ${{ secrets.ALIYUN_DOCKER_HUB_USER }}
        password: ${{ secrets.ALIYUN_DOCKER_HUB_TOKEN }}

    # 7. 构建 Docker 镜像并推送到阿里云
    - name: Build and push Docker image
      if: github.event_name == 'push'
      uses: docker/build-push-action@v3
      with:
        context: ./docker
        push: true # 只有在上面登录成功后才会推送
        tags: ${{ env.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_DOCKER_HUB_USER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    # 8. 设置 SSH 密钥，用于连接服务器
    - name: Setup SSH Agent
      if: github.event_name == 'push'
      uses: webfactory/ssh-agent@v0.5.4 # 使用较新版本
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    # 9. 将服务器的公钥添加到 known_hosts，防止 SSH 首次连接询问
    - name: Add remote server to known hosts
      if: github.event_name == 'push'
      run: ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    # 10. 部署到服务器
    - name: Deploy to Server
      if: github.event_name == 'push'
      run: |
        # 使用 SSH 连接到你的服务器并执行一系列部署命令
        ssh root@${{ secrets.SERVER_HOST }} << 'EOF'
          # 定义变量，方便管理
          REGISTRY="${{ env.ALIYUN_REGISTRY }}"
          USER="${{ secrets.ALIYUN_DOCKER_HUB_USER }}"
          IMAGE_NAME="${{ env.IMAGE_NAME }}"
          IMAGE_TAG="${{ env.IMAGE_TAG }}"
          PORT="${{ env.PORT }}"
          
          FULL_IMAGE_NAME="${REGISTRY}/${USER}/${IMAGE_NAME}:${IMAGE_TAG}"
          
          echo ">>> 正在部署: ${FULL_IMAGE_NAME}"
          
          echo "1. 停止并删除旧的容器..."
          docker stop ${IMAGE_NAME} || true
          docker rm ${IMAGE_NAME} || true
          
          echo "2. 删除旧的镜像..."
          docker rmi ${FULL_IMAGE_NAME} || true
          
          echo "3. 拉取最新的镜像..."
          docker pull ${FULL_IMAGE_NAME}
          
          echo "4. 启动新的容器..."
          docker run -p ${PORT}:${PORT} --name ${IMAGE_NAME} -d ${FULL_IMAGE_NAME}
          
          echo ">>> 部署完成！"
        EOF

